{% extends 'dashboard/base.html' %}

{% block title %}Protocol Library - LIMS{% endblock %}

{% block extra_css %}
<style>
    .protocol-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.5rem;
        margin-top: 1.5rem;
    }
    
    .protocol-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: all 0.3s;
        border-left: 4px solid #667eea;
    }
    
    .protocol-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }
    
    .protocol-code {
        font-size: 0.9rem;
        font-weight: bold;
        color: #667eea;
        margin-bottom: 0.5rem;
    }
    
    .protocol-title {
        font-size: 1.25rem;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 0.5rem;
    }
    
    .protocol-description {
        color: #666;
        font-size: 0.95rem;
        margin-bottom: 1rem;
        line-height: 1.5;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .protocol-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }
    
    .meta-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.35rem 0.75rem;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .status-badge {
        background: #e3f2fd;
        color: #1976d2;
    }
    
    .status-badge.APPROVED {
        background: #e8f5e9;
        color: #2e7d32;
    }
    
    .status-badge.DRAFT {
        background: #fff3e0;
        color: #f57c00;
    }
    
    .status-badge.REVIEW {
        background: #e1f5fe;
        color: #0277bd;
    }
    
    .status-badge.ARCHIVED {
        background: #f5f5f5;
        color: #616161;
    }
    
    .category-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.35rem 0.75rem;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
        color: white;
    }
    
    .version-badge {
        background: #f3e5f5;
        color: #7b1fa2;
    }
    
    .usage-badge {
        background: #fce4ec;
        color: #c2185b;
    }
    
    .protocol-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 1rem;
        border-top: 1px solid #e0e0e0;
    }
    
    .protocol-author {
        font-size: 0.85rem;
        color: #999;
    }
    
    .view-button {
        padding: 0.5rem 1rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        text-decoration: none;
        font-weight: 600;
        transition: transform 0.2s;
    }
    
    .view-button:hover {
        transform: translateY(-2px);
    }
    
    .search-section {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
    }
    
    .search-input {
        flex: 1;
        min-width: 250px;
        padding: 0.75rem;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1rem;
    }
    
    .filter-select {
        padding: 0.75rem;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1rem;
        background: white;
    }
    
    .add-button {
        padding: 0.75rem 1.5rem;
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        text-decoration: none;
        display: inline-block;
    }
    
    .no-protocols {
        text-align: center;
        padding: 3rem;
        color: #999;
    }
    
    .filter-chips {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }
    
    .filter-chip {
        padding: 0.5rem 1rem;
        background: #f5f5f5;
        border: 2px solid #e0e0e0;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 0.9rem;
    }
    
    .filter-chip:hover {
        background: #e0e0e0;
    }
    
    .filter-chip.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2>Protocol Library</h2>
        <a href="/admin/protocols/protocol/add/" class="add-button">+ New Protocol</a>
    </div>
    
    <div class="filter-chips">
        <div class="filter-chip active" onclick="filterByStatus('ALL')">All</div>
        <div class="filter-chip" onclick="filterByStatus('APPROVED')">‚úì Approved</div>
        <div class="filter-chip" onclick="filterByStatus('DRAFT')">üìù Draft</div>
        <div class="filter-chip" onclick="filterByStatus('REVIEW')">üëÅÔ∏è Review</div>
        <div class="filter-chip" onclick="filterByStatus('ARCHIVED')">üì¶ Archived</div>
    </div>
    
    <div class="search-section">
        <input type="text" id="search-input" class="search-input" placeholder="Search protocols by title, code, description...">
        <select id="category-filter" class="filter-select">
            <option value="">All Categories</option>
        </select>
        <button onclick="filterProtocols()" class="view-button">Search</button>
    </div>
    
    <div id="protocols-container">
        <div class="protocol-grid" id="protocols-grid">
            <div style="text-align: center; padding: 2rem; grid-column: 1/-1;">Loading protocols...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let allProtocols = [];
    let allCategories = [];
    let currentStatusFilter = 'ALL';
    
    function loadCategories() {
        fetch('/api/protocol-categories/', { credentials: 'same-origin' })
            .then(response => response.json())
            .then(data => {
                allCategories = data;
                const categorySelect = document.getElementById('category-filter');
                
                data.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading categories:', error);
            });
    }
    
    function loadProtocols() {
        fetch('/api/protocols/', { credentials: 'same-origin' })
            .then(response => response.json())
            .then(data => {
                allProtocols = data.results || [];
                displayProtocols(allProtocols);
            })
            .catch(error => {
                console.error('Error loading protocols:', error);
                document.getElementById('protocols-grid').innerHTML = 
                    '<div style="text-align: center; padding: 2rem; color: red; grid-column: 1/-1;">Error loading protocols</div>';
            });
    }
    
    function displayProtocols(protocols) {
        const grid = document.getElementById('protocols-grid');
        
        if (protocols.length === 0) {
            grid.innerHTML = `
                <div class="no-protocols" style="grid-column: 1/-1;">
                    <h3>No protocols found</h3>
                    <p>Create your first protocol to get started!</p>
                </div>
            `;
            return;
        }
        
        grid.innerHTML = protocols.map(protocol => {
            const statusClass = protocol.status || 'DRAFT';
            const categoryColor = protocol.category_color || '#667eea';
            const createdDate = new Date(protocol.created_at).toLocaleDateString();
            
            return `
                <div class="protocol-card" style="border-left-color: ${categoryColor};">
                    <div class="protocol-code">${protocol.protocol_code} v${protocol.version}</div>
                    <div class="protocol-title">${protocol.title}</div>
                    <div class="protocol-description">${protocol.description || 'No description'}</div>
                    
                    <div class="protocol-meta">
                        <span class="meta-badge status-badge ${statusClass}">${statusClass}</span>
                        ${protocol.category_name ? `<span class="category-badge" style="background-color: ${categoryColor};">${protocol.category_name}</span>` : ''}
                        <span class="meta-badge version-badge">v${protocol.version}</span>
                        <span class="meta-badge usage-badge">üìä Used ${protocol.times_used}x</span>
                    </div>
                    
                    <div class="protocol-footer">
                        <div>
                            <div class="protocol-author">üë§ ${protocol.created_by_name || 'Unknown'}</div>
                            <div class="protocol-author">üìÖ ${createdDate}</div>
                        </div>
                        <a href="/dashboard/protocols/${protocol.id}/" class="view-button">View Details</a>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    function filterByStatus(status) {
        currentStatusFilter = status;
        
        // Update active chip
        document.querySelectorAll('.filter-chip').forEach(chip => {
            chip.classList.remove('active');
        });
        event.target.classList.add('active');
        
        filterProtocols();
    }
    
    function filterProtocols() {
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        const categoryFilter = document.getElementById('category-filter').value;
        
        let filtered = allProtocols;
        
        // Apply status filter
        if (currentStatusFilter !== 'ALL') {
            filtered = filtered.filter(protocol => protocol.status === currentStatusFilter);
        }
        
        // Apply search filter
        if (searchTerm) {
            filtered = filtered.filter(protocol => 
                protocol.title.toLowerCase().includes(searchTerm) ||
                protocol.protocol_code.toLowerCase().includes(searchTerm) ||
                (protocol.description && protocol.description.toLowerCase().includes(searchTerm))
            );
        }
        
        // Apply category filter
        if (categoryFilter) {
            filtered = filtered.filter(protocol => protocol.category === parseInt(categoryFilter));
        }
        
        displayProtocols(filtered);
    }
    
    // Load data when page loads
    loadCategories();
    loadProtocols();
    
    // Allow Enter key to trigger search
    document.getElementById('search-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            filterProtocols();
        }
    });
    
    // Auto-filter on category change
    document.getElementById('category-filter').addEventListener('change', filterProtocols);
</script>
{% endblock %}